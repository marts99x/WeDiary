<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WeDiary</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background: #fdf2f8; margin: 0; padding: 0; line-height: 1.6; }
    header { background: #ec4899; color: white; padding: 1rem; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .container { max-width: 700px; margin: 2rem auto; padding: 1rem; }
    .card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    input, textarea { width: 90%; padding: 0.8rem; margin: 0.5rem 0; border-radius: 8px; border: 1px solid #ddd; font-size: 1rem; box-sizing: border-box; }
    textarea { min-height: 150px; resize: vertical; overflow-y: auto; }
    .button, .small-btn { transition: transform 0.2s, opacity 0.2s; }
    .button { display: inline-block; background: #ec4899; color: white; padding: 0.6rem 1.2rem; border-radius: 999px; font-size: 1rem; cursor: pointer; border: none; margin-top: 1rem; }
    .button:hover { opacity: 0.9; transform: translateY(-2px); }
    .logout { background: #ef4444; }
    .hidden { display: none; }
    #profileSection { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 2rem; margin-bottom: 2rem; text-align: center; position: relative; }
    .profile-image { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; margin-bottom: 1rem; border: 4px solid #ec4899; }
    .edit-profile-btn { position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: #aaa; cursor: pointer; }
    .edit-profile-btn:hover { color: #ec4899; }
    .entry { background: repeating-linear-gradient(to bottom, #fff 0px, #fff 23px, #fce7f3 24px); border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1rem; text-align: left; }
    .entry p { text-align: justify; white-space: pre-wrap; margin-bottom: 1rem; }
    .time { font-size: 0.8rem; color: gray; margin-top: 0.5rem; }
    .actions { display: flex; gap: 0.5rem; margin-top: 1rem; }
    .small-btn { padding: 0.3rem 0.6rem; border-radius: 6px; font-size: 0.8rem; border: none; cursor: pointer; }
    .small-btn.edit { background: #3b82f6; color: white; }
    .small-btn.delete { background: #ef4444; color: white; }
    .reaction { margin-top: 1rem; display: flex; align-items: center; gap: 0.5rem; }
    .love-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; transition: transform 0.2s; }
    .love-btn:hover { transform: scale(1.2); }
    .entry img, .entry video { max-width: 100%; max-height: 350px; border-radius: 10px; margin-top: 0.5rem; display: block; object-fit: cover; }
    .comments { margin-top: 1rem; display: flex; flex-direction: column; gap: 0.4rem; }
    .comment { max-width: 70%; padding: 0.6rem 1rem; border-radius: 15px; font-size: 0.9rem; position: relative; word-wrap: break-word; }
    .comment.you { background: #dbeafe; align-self: flex-end; border-bottom-right-radius: 5px; }
    .comment.partner { background: #fce7f3; align-self: flex-start; border-bottom-left-radius: 5px; }
    .comment span { display: block; }
    .comment small { font-size: 0.75rem; color: #666; margin-left: 0.5rem; }
    .comment button { position: absolute; top: -6px; right: -6px; background: #ef4444; border: none; border-radius: 50%; color: white; font-size: 0.7rem; padding: 2px 5px; cursor: pointer; }
    #entryForm .media-preview { margin-top: 1rem; }
    form.comment-form { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
    form.comment-form input { width: 70%; padding: 0.5rem; border-radius: 8px; border: 1px solid #ddd; }
    form.comment-form button { padding: 0.4rem 0.6rem; }
  </style>
</head>
<body>
  <header><h1>üìñ WeDiary</h1></header>

  <div id="loginPage" class="container">
    <div class="card">
      <h2>üîí Masuk ke WeDiary</h2>
      <input type="password" id="token1" placeholder="Token Kamu" required />
      <input type="password" id="token2" placeholder="Token Pasangan" required />
      <button class="button" onclick="login()">Masuk</button>
      <p id="loginError" style="color:red; display:none; margin-top:1rem;">Token salah, coba lagi!</p>
    </div>
  </div>

  <div id="diaryPage" class="container hidden">
    <div id="profileSection">
      <img src="https://via.placeholder.com/150" class="profile-image" id="profileImage">
      <h3 id="profileName">Pasanganmu</h3>
      <p>Bersama sejak <span id="datingDate"></span></p>
      <button class="small-btn edit-profile-btn" onclick="toggleEditProfile()">‚úèÔ∏è</button>
    </div>

    <form id="editProfileForm" class="card hidden" onsubmit="saveProfile(event)">
      <h2>‚úçÔ∏è Edit Profil</h2>
      <input type="text" id="editName" placeholder="Nama Pasangan" required />
      <input type="text" id="editDatingDate" placeholder="Tanggal Jadian (DD-MM-YYYY)" required />
      <p>Pilih Foto Baru:</p>
      <input type="file" id="editPhoto" accept="image/*" />
      <button type="submit" class="button">Simpan Perubahan</button>
    </form>

    <div style="display:flex; gap:0.5rem; margin-bottom:1rem;">
      <button class="button" onclick="toggleForm()">+ Tambah Entry</button>
      <button class="button logout" onclick="logout()">üö™ Logout</button>
    </div>

    <form id="entryForm" onsubmit="saveEntry(event)" class="hidden card">
      <h2>‚úçÔ∏è Tulis Entri</h2>
      <input type="text" id="mood" placeholder="Mood (üòä / üò¢ / üòç)" required />
      <input type="text" id="title" placeholder="Judul" required />
      <textarea id="content" placeholder="Tulis ceritamu di sini..." required></textarea>
      <input type="file" id="media" accept="image/*,video/*" />
      <div id="mediaPreview" class="media-preview hidden"></div>
      <div style="display:flex; gap:0.5rem; margin-top:0.5rem;">
        <button type="submit" class="button">Simpan Entry</button>
        <button type="button" class="button logout" onclick="cancelEdit()">Batal</button>
      </div>
    </form>

    <div id="entries"></div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script>
    // ===== CONFIG =====
    const SUPABASE_URL = "https://fysptdalfoklfvihimfv.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ5c3B0ZGFsZm9rbGZ2aWhpbWZ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2MTU0NjcsImV4cCI6MjA3NDE5MTQ2N30.wOE0br4Wwb36AjFmLyybksO_TyB64guNg0c2z85kAe4"; // ganti dengan anon keymu
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let editingIndex = null;

    // simple token pair (lokal)
    function getTokens() { return { user: "20825", partner: "30309" }; }

    /* ===== PROFILE ===== */
    async function getProfileData() {
      const { data, error } = await db.from("profiles").select("*").limit(1).single();
      if (error || !data) return { photo_url: "https://via.placeholder.com/150", name: "Beb", dating_date: "14-02-2023" };
      return data;
    }

    async function renderProfile() {
      const profile = await getProfileData();
      document.getElementById("profileImage").src = profile.photo_url;
      document.getElementById("profileName").innerText = profile.name;
      try {
        const parts = profile.dating_date.split("-");
        const startDate = new Date(parts[2], parts[1] - 1, parts[0]);
        const diffDays = Math.floor((new Date() - startDate) / (1000*60*60*24));
        document.getElementById("datingDate").innerText = `${profile.dating_date} ‚Ä¢ ${diffDays} hari bersama üíï`;
      } catch (err) {
        document.getElementById("datingDate").innerText = profile.dating_date;
      }
    }

    async function saveProfile(e) {
      e.preventDefault();
      const newName = document.getElementById("editName").value;
      const newDate = document.getElementById("editDatingDate").value;
      const newPhotoFile = document.getElementById("editPhoto").files[0];

      const finishSave = async (url) => {
        const { data: existing } = await db.from("profiles").select("*").limit(1).single();
        if (existing) {
          await db.from("profiles").update({ name: newName, dating_date: newDate, photo_url: url }).eq("id", existing.id);
        } else {
          await db.from("profiles").insert({ name: newName, dating_date: newDate, photo_url: url });
        }
        renderProfile();
        toggleEditProfile();
      };

      if (newPhotoFile) {
        const r = new FileReader();
        r.onload = ev => finishSave(ev.target.result);
        r.readAsDataURL(newPhotoFile);
      } else {
        const { data: existing } = await db.from("profiles").select("*").limit(1).single();
        finishSave(existing?.photo_url || "https://via.placeholder.com/150");
      }
    }

    function toggleEditProfile() {
      document.getElementById("editProfileForm").classList.toggle("hidden");
    }

    /* ===== ENTRIES ===== */
    async function loadEntries() {
      const { data, error } = await db.from("entries").select("*").order("id", { ascending: false });
      if (error) { console.error(error); return []; }
      return data;
    }

    async function renderEntries() {
      const entries = await loadEntries();
      const container = document.getElementById("entries");
      container.innerHTML = "";

      entries.forEach((entry) => {
        const commentsHTML = (entry.comments || []).map((c, i) => {
          const label = c.author === "you" ? `üíô` : `üíñ`;
          const cls = c.author === "you" ? "you" : "partner";
          const deleteBtn = c.author === currentUser ? `<button onclick="deleteComment(${entry.id}, ${i})">x</button>` : '';
          return `<div class="comment ${cls}"><span><b>${label}</b> ${escapeHtml(c.text)}<br><small>${c.time}</small></span>${deleteBtn}</div>`;
        }).join("");

        const mediaHTML = entry.media || "";
        const actionsHTML = entry.author === currentUser ? `
          <div class="actions">
            <button class="small-btn edit" onclick="editEntry(${entry.id})">Edit</button>
            <button class="small-btn delete" onclick="deleteEntry(${entry.id})">Hapus</button>
          </div>` : "";

        container.insertAdjacentHTML("beforeend", `
          <div class="entry">
            <h3>${escapeHtml(entry.mood)} ${escapeHtml(entry.title)}</h3>
            <p>${escapeHtml(entry.content).replace(/\n/g, '<br>')}</p>
            ${mediaHTML}
            <p class="time">${escapeHtml(entry.date)} ‚Äî ${escapeHtml(entry.time)} üîí Private</p>
            ${actionsHTML}
            <div class="reaction"><button class="love-btn" onclick="loveEntry(${entry.id})">‚ù§Ô∏è</button> ${entry.loves || 0} Love</div>
            <div class="comments">
              ${commentsHTML}
              <form class="comment-form" onsubmit="addComment(event, ${entry.id})">
                <input type="text" placeholder="Tulis komentar..." required />
                <button class="small-btn" type="submit">Kirim</button>
              </form>
            </div>
          </div>
        `);
      });
    }

    // helper untuk mencegah injeksi HTML (safety)
    function escapeHtml(str) {
      if (str == null) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    async function saveEntry(e) {
      e.preventDefault();
      const mood = document.getElementById("mood").value;
      const title = document.getElementById("title").value;
      const content = document.getElementById("content").value;
      const file = document.getElementById("media").files[0];
      const now = new Date();
      const date = now.toLocaleDateString("id-ID", { day: "2-digit", month: "short", year: "numeric" });
      const time = now.toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" });

      const finishSave = async (mediaHTML) => {
        if (editingIndex) {
          await db.from("entries").update({ mood, title, content, media: mediaHTML, date, time }).eq("id", editingIndex);
          editingIndex = null;
        } else {
          await db.from("entries").insert([{ mood, title, content, media: mediaHTML, date, time, loves: 0, comments: [], author: currentUser }]);
        }
        document.getElementById("entryForm").reset();
        document.getElementById("entryForm").classList.add("hidden");
        document.getElementById("mediaPreview").innerHTML = "";
        renderEntries();
      };

      if (file) {
        const r = new FileReader();
        r.onload = ev => {
          let mediaHTML = "";
          if (file.type.startsWith("image/")) mediaHTML = `<img src="${ev.target.result}" />`;
          else if (file.type.startsWith("video/")) mediaHTML = `<video src="${ev.target.result}" controls></video>`;
          finishSave(mediaHTML);
        };
        r.readAsDataURL(file);
      } else {
        // jika edit dan tidak upload file baru, gunakan preview (media lama)
        finishSave(editingIndex ? document.getElementById("mediaPreview").innerHTML : "");
      }
    }

    async function editEntry(id) {
      const { data } = await db.from("entries").select("*").eq("id", id).single();
      if (!data) return;
      editingIndex = id;
      document.getElementById("entryForm").classList.remove("hidden");
      document.getElementById("mood").value = data.mood || "";
      document.getElementById("title").value = data.title || "";
      document.getElementById("content").value = data.content || "";
      document.getElementById("mediaPreview").innerHTML = data.media || "";
      // scroll ke form agar user tahu sedang edit
      document.getElementById("entryForm").scrollIntoView({ behavior: "smooth" });
    }

    async function deleteEntry(id) {
      if (!confirm("Yakin mau hapus entry ini?")) return;
      await db.from("entries").delete().eq("id", id);
      renderEntries();
    }

    async function loveEntry(id) {
      const { data } = await db.from("entries").select("loves").eq("id", id).single();
      const loves = (data?.loves || 0) + 1;
      await db.from("entries").update({ loves }).eq("id", id);
      renderEntries();
    }

    /* ===== KOMENTAR ===== */
    async function addComment(e, id) {
      e.preventDefault();
      const input = e.target.querySelector("input");
      const text = input.value.trim();
      if (!text) return;
      const { data } = await db.from("entries").select("comments").eq("id", id).single();
      const comments = data?.comments || [];
      const now = new Date();
      const time = now.toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" });
      comments.push({ text, author: currentUser, time });
      await db.from("entries").update({ comments }).eq("id", id);
      input.value = "";
      renderEntries();
    }

    async function deleteComment(id, index) {
      if (!confirm("Hapus komentar ini?")) return;
      const { data } = await db.from("entries").select("comments").eq("id", id).single();
      const comments = data?.comments || [];
      comments.splice(index, 1);
      await db.from("entries").update({ comments }).eq("id", id);
      renderEntries();
    }

    /* ===== AUTH & UI helpers ===== */
    function login() {
      const { user, partner } = getTokens();
      const t1 = document.getElementById("token1").value;
      const t2 = document.getElementById("token2").value;

      if (t1 === user && t2 === partner) currentUser = "you";
      else if (t1 === partner && t2 === user) currentUser = "partner";
      else {
        document.getElementById("loginError").style.display = "block";
        return;
      }

      document.getElementById("loginPage").classList.add("hidden");
      document.getElementById("diaryPage").classList.remove("hidden");
      renderProfile();
      renderEntries();
    }

    function logout() {
      currentUser = null;
      document.getElementById("loginPage").classList.remove("hidden");
      document.getElementById("diaryPage").classList.add("hidden");
      // reset form & editing
      cancelEdit();
    }

    function toggleForm() {
      const form = document.getElementById("entryForm");
      form.classList.toggle("hidden");
      if (!form.classList.contains("hidden")) {
        // reset when opening new form (not editing)
        editingIndex = null;
        document.getElementById("entryForm").reset();
        document.getElementById("mediaPreview").innerHTML = "";
      }
    }

    function cancelEdit() {
      document.getElementById("entryForm").reset();
      document.getElementById("entryForm").classList.add("hidden");
      editingIndex = null;
      document.getElementById("mediaPreview").innerHTML = "";
    }

    // üîπ Auto login
    window.onload = () => {
      const saved = localStorage.getItem("currentUser");
      if (saved) {
        currentUser = saved;
        document.getElementById("loginPage").classList.add("hidden");
        document.getElementById("diaryPage").classList.remove("hidden");
        renderProfile();
        renderEntries();
      }

    // initial (optional) ‚Äî if you want to auto-render public view uncomment below:
    // renderProfile(); renderEntries();
  </script>
</body>
</html>
