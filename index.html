<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WeDiary ‚Äî Realtime</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family:'Poppins',sans-serif; background:#fdf2f8; margin:0; padding:0; line-height:1.6; }
    header { background:#ec4899; color:#fff; padding:1rem; text-align:center; box-shadow:0 4px 6px rgba(0,0,0,0.1); }
    .container { max-width:700px; margin:2rem auto; padding:1rem; }
    .card { background:#fff; padding:2rem; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    input, textarea { width:90%; padding:0.8rem; margin:0.5rem 0; border-radius:8px; border:1px solid #ddd; font-size:1rem; box-sizing:border-box; }
    .button, .small-btn { transition:transform .2s, opacity .2s; }
    .button { display:inline-block; background:#ec4899; color:#fff; padding:.6rem 1.2rem; border-radius:999px; font-size:1rem; cursor:pointer; border:none; margin-top:1rem; }
    .logout { background:#ef4444; }
    .hidden { display:none; }
    #profileSection { background:#fff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); padding:2rem; margin-bottom:2rem; text-align:center; position:relative; }
    .profile-image { width:150px; height:150px; border-radius:50%; object-fit:cover; margin-bottom:1rem; border:4px solid #ec4899; }
    .edit-profile-btn { position:absolute; top:1rem; right:1rem; background:none; border:none; color:#aaa; cursor:pointer; }
    .entry { background:repeating-linear-gradient(to bottom,#fff 0px,#fff 23px,#fce7f3 24px); border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); padding:1.5rem; margin-bottom:1rem; text-align:left; }
    .time { font-size:.8rem; color:gray; margin-top:.5rem; }
    .actions { display:flex; gap:.5rem; margin-top:1rem; }
    .small-btn { padding:.3rem .6rem; border-radius:6px; font-size:.8rem; border:none; cursor:pointer; }
    .small-btn.edit { background:#3b82f6; color:#fff; }
    .small-btn.delete { background:#ef4444; color:#fff; }
    .reaction { margin-top:1rem; display:flex; align-items:center; gap:.5rem; }
    .love-btn { background:none; border:none; font-size:1.5rem; cursor:pointer; transition:transform .2s; }
    .entry img, .entry video { max-width:100%; max-height:350px; border-radius:10px; margin-top:.5rem; display:block; object-fit:cover; }
    .comments { margin-top:1rem; display:flex; flex-direction:column; gap:.4rem; }
    .comment { max-width:70%; padding:.6rem 1rem; border-radius:15px; font-size:.9rem; position:relative; word-wrap:break-word; }
    .comment.you { background:#dbeafe; align-self:flex-end; border-bottom-right-radius:5px; }
    .comment.partner { background:#fce7f3; align-self:flex-start; border-bottom-left-radius:5px; }
    #entryForm .media-preview { margin-top:1rem; }
    /* Notif */
    #notif { position:fixed; bottom:20px; right:20px; background:#ec4899; color:#fff; padding:12px 18px; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.2); font-size:0.9rem; opacity:0; transform:translateY(20px); transition:all .4s ease; z-index:9999; }
    #notif.show { opacity:1; transform:translateY(0); }
  </style>
</head>
<body>
  <header><h1>üìñ WeDiary</h1></header>

  <div id="loginPage" class="container">
    <div class="card">
      <h2>üîí Masuk ke WeDiary</h2>
      <input type="password" id="token1" placeholder="Token Kamu" required />
      <input type="password" id="token2" placeholder="Token Pasangan" required />
      <button class="button" onclick="login()">Masuk</button>
      <p id="loginError" style="color:red; display:none; margin-top:1rem;">Token salah, coba lagi!</p>
    </div>
  </div>

  <div id="diaryPage" class="container hidden">
    <div id="profileSection">
      <img src="https://via.placeholder.com/150" class="profile-image" id="profileImage">
      <h3 id="profileName">Pasanganmu</h3>
      <p>Bersama sejak <span id="datingDate"></span></p>
      <button class="small-btn edit-profile-btn" onclick="toggleEditProfile()">‚úèÔ∏è</button>
    </div>

    <form id="editProfileForm" class="card hidden" onsubmit="saveProfile(event)">
      <h2>‚úçÔ∏è Edit Profil</h2>
      <input type="text" id="editName" placeholder="Nama Pasangan" required />
      <input type="text" id="editDatingDate" placeholder="Tanggal Jadian (DD-MM-YYYY)" required />
      <p>Pilih Foto Baru:</p>
      <input type="file" id="editPhoto" accept="image/*" />
      <button type="submit" class="button">Simpan Perubahan</button>
    </form>

    <button class="button" onclick="toggleForm()">+ Tambah Entry</button>
    <button class="button logout" onclick="logout()">üö™ Logout</button>

    <form id="entryForm" onsubmit="saveEntry(event)" class="hidden card">
      <h2>‚úçÔ∏è Tulis Entri</h2>
      <input type="text" id="mood" placeholder="Mood (üòä / üò¢ / üòç)" required />
      <input type="text" id="title" placeholder="Judul" required />
      <textarea id="content" placeholder="Tulis ceritamu di sini..." rows="4" required></textarea>
      <input type="file" id="media" accept="image/*,video/*" />
      <div id="mediaPreview" class="media-preview hidden"></div>
      <button type="submit" class="button">Simpan Entry</button>
      <button type="button" class="button logout" onclick="cancelEdit()">Batal</button>
    </form>

    <div id="entries"></div>
  </div>

  <!-- Notif + sound -->
  <div id="notif"></div>
  <audio id="notifSound" src="https://assets.mixkit.co/sfx/preview/mixkit-bell-notification-933.mp3" preload="auto"></audio>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script>
    // ---------- CONFIG ----------
    const SUPABASE_URL = "https://fysptdalfoklfvihimfv.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ5c3B0ZGFsZm9rbGZ2aWhpbWZ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2MTU0NjcsImV4cCI6MjA3NDE5MTQ2N30.wOE0br4Wwb36AjFmLyybksO_TyB64guNg0c2z85kAe4"; // ‚ö†Ô∏è GANTI dgn anon key kamu
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const PHOTO_BUCKET = "photos"; // pastikan bucket ini ada di Supabase Storage

    // ---------- STATE ----------
    let currentUser = null;
    let editingIndex = null;
    let currentMediaURL = "";   // URL (public) dari media lama saat edit
    let currentMediaPath = "";  // path di storage (untuk delete jika perlu)

    // ---------- UTIL ----------
    function getTokens() { return { user: "20825", partner: "30309" }; }

    function showNotif(msg) {
      const n = document.getElementById("notif");
      const sound = document.getElementById("notifSound");
      n.textContent = msg;
      n.classList.add("show");
      // play sound (browser may require user interaction before allowed)
      try { sound.currentTime = 0; sound.play(); } catch(e){ /* ignore */ }
      setTimeout(()=> n.classList.remove("show"), 3200);
    }

    // ---------- PROFILE ----------
    async function getProfileData() {
      const { data, error } = await db.from("profiles").select("*").limit(1).single();
      if (error || !data) return { photo_url: "https://via.placeholder.com/150", name: "Beb", dating_date: "14-02-2023" };
      return data;
    }
    async function renderProfile() {
      const profile = await getProfileData();
      document.getElementById("profileImage").src = profile.photo_url;
      document.getElementById("profileName").innerText = profile.name;
      const parts = profile.dating_date.split("-");
      const startDate = new Date(parts[2], parts[1]-1, parts[0]);
      const diffDays = Math.floor((new Date() - startDate) / (1000*60*60*24));
      document.getElementById("datingDate").innerText = `${profile.dating_date} ‚Ä¢ ${diffDays} hari bersama üíï`;
    }
    async function saveProfile(e) {
      e.preventDefault();
      const newName = document.getElementById("editName").value;
      const newDate = document.getElementById("editDatingDate").value;
      const newPhotoFile = document.getElementById("editPhoto").files[0];

      const finishSave = async (photoUrl) => {
        const { data: existing } = await db.from("profiles").select("*").limit(1).single();
        if (existing) {
          await db.from("profiles").update({ name: newName, dating_date: newDate, photo_url: photoUrl }).eq("id", existing.id);
        } else {
          await db.from("profiles").insert({ name: newName, dating_date: newDate, photo_url: photoUrl });
        }
        renderProfile();
        toggleEditProfile();
      };

      if (newPhotoFile) {
        // Upload to storage
        const ext = newPhotoFile.name.split('.').pop();
        const path = `profiles/${Date.now()}.${ext}`;
        const { data, error } = await db.storage.from(PHOTO_BUCKET).upload(path, newPhotoFile, { upsert: true });
        if (error) { alert("Gagal upload foto profil"); return; }
        const publicUrl = db.storage.from(PHOTO_BUCKET).getPublicUrl(data.path).data.publicUrl;
        finishSave(publicUrl);
      } else {
        const { data: existing } = await db.from("profiles").select("*").limit(1).single();
        finishSave(existing?.photo_url || "https://via.placeholder.com/150");
      }
    }
    function toggleEditProfile(){ document.getElementById("editProfileForm").classList.toggle("hidden"); }

    // ---------- ENTRIES ----------
    async function loadEntries() {
      const { data, error } = await db.from("entries").select("*").order("id", { ascending: false });
      if (error) { console.error(error); return []; }
      return data;
    }

    async function renderEntries() {
      const entries = await loadEntries();
      const container = document.getElementById("entries");
      container.innerHTML = "";
      entries.forEach(entry => {
        const commentsHTML = (entry.comments || []).map((c,i)=>{
          const label = c.author==="you" ? "üíô" : "üíñ";
          const cls = c.author==="you" ? "you" : "partner";
          const delBtn = c.author===currentUser ? `<button onclick="deleteComment(${entry.id},${i})">x</button>` : "";
          return `<div class="comment ${cls}"><span><b>${label}:</b> ${escapeHtml(c.text)} <br><small>${c.time}</small></span>${delBtn}</div>`;
        }).join("");

        const mediaHTML = entry.media ? entry.media : "";
        const actions = entry.author===currentUser ? `
          <div class="actions">
            <button class="small-btn edit" onclick="editEntry(${entry.id})">Edit</button>
            <button class="small-btn delete" onclick="deleteEntry(${entry.id})">Hapus</button>
          </div>` : "";

        container.insertAdjacentHTML("beforeend", `
          <div class="entry">
            <h3>${escapeHtml(entry.mood)} ${escapeHtml(entry.title)}</h3>
            <p>${escapeHtml(entry.content)}</p>
            ${mediaHTML}
            <p class="time">${escapeHtml(entry.date)} ‚Äî ${escapeHtml(entry.time)} üîí Private</p>
            ${actions}
            <div class="reaction">
              <button class="love-btn" onclick="loveEntry(${entry.id})">‚ù§Ô∏è</button> ${entry.loves || 0} Love
            </div>
            <div class="comments">
              ${commentsHTML}
              <form onsubmit="addComment(event, ${entry.id})">
                <input type="text" placeholder="Tulis komentar..." required />
                <button class="small-btn" type="submit">Kirim</button>
              </form>
            </div>
          </div>
        `);
      });
    }

    function escapeHtml(text) {
      if (!text && text !== "") return "";
      return String(text).replace(/[&<>"'`=\/]/g, function (s) {
        return ({
          '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;",'/':'&#x2F;','`':'&#x60;','=':'&#x3D;'
        })[s];
      });
    }

    // Preview handler & size limit
    document.getElementById("media").addEventListener("change", function(){
      const file = this.files[0];
      const preview = document.getElementById("mediaPreview");
      preview.innerHTML = "";
      if (!file) { preview.classList.add("hidden"); return; }
      if (file.size > 5*1024*1024) { alert("File maksimal 5MB ya beb üòÖ"); this.value = ""; preview.classList.add("hidden"); return; }
      let el;
      if (file.type.startsWith("image/")) el = document.createElement("img");
      else if (file.type.startsWith("video/")) { el = document.createElement("video"); el.controls = true; }
      if (el) {
        el.src = URL.createObjectURL(file);
        el.style.maxWidth = "100%";
        el.style.maxHeight = "350px";
        preview.appendChild(el);
        preview.classList.remove("hidden");
      }
    });

    // Save entry: upload media to Storage (if file), store public URL in entry.media (as HTML string)
    async function saveEntry(e) {
      e.preventDefault();
      const mood = document.getElementById("mood").value;
      const title = document.getElementById("title").value;
      const content = document.getElementById("content").value;
      const file = document.getElementById("media").files[0];
      const now = new Date();
      const date = now.toLocaleDateString("id-ID", { day:"2-digit", month:"short", year:"numeric" });
      const time = now.toLocaleTimeString("id-ID", { hour:"2-digit", minute:"2-digit" });

      let mediaHTML = currentMediaURL || ""; // default: media lama (public URL embedded HTML) or empty

      if (file) {
        if (file.size > 5*1024*1024) { alert("File maksimal 5MB üòÖ"); return; }
        const ext = file.name.split('.').pop();
        const path = `entries/${Date.now()}.${ext}`;
        const { data, error } = await db.storage.from(PHOTO_BUCKET).upload(path, file, { upsert: true });
        if (error) { alert("Gagal upload media üò¢"); console.error(error); return; }
        const publicUrl = db.storage.from(PHOTO_BUCKET).getPublicUrl(data.path).data.publicUrl;
        // build embed HTML based on file type
        if (file.type.startsWith("image/")) mediaHTML = `<img src="${publicUrl}" />`;
        else if (file.type.startsWith("video/")) mediaHTML = `<video src="${publicUrl}" controls></video>`;
        // optionally delete previous media file if it was in same bucket and we want to free storage
        if (editingIndex && currentMediaPath) {
          try { await db.storage.from(PHOTO_BUCKET).remove([currentMediaPath]); } catch(_) { /* ignore */ }
        }
        // save path for potential future delete
        currentMediaPath = data.path;
        currentMediaURL = mediaHTML;
      }

      if (editingIndex === null) {
        await db.from("entries").insert([{ mood, title, content, media: mediaHTML, date, time, loves: 0, comments: [], author: currentUser }]);
      } else {
        await db.from("entries").update({ mood, title, content, media: mediaHTML }).eq("id", editingIndex);
        editingIndex = null;
        currentMediaURL = "";
        currentMediaPath = "";
      }

      document.getElementById("entryForm").classList.add("hidden");
      document.getElementById("entryForm").reset();
      document.getElementById("mediaPreview").innerHTML = "";
      document.getElementById("mediaPreview").classList.add("hidden");
    }

    async function editEntry(id) {
      const { data } = await db.from("entries").select("*").eq("id", id).single();
      if (!data) return;
      editingIndex = id;
      // if media is stored as <img src="..."> we extract URL for potential deletion check
      currentMediaURL = data.media || "";
      // attempt to extract storage path from URL (not always possible if using external URL)
      try {
        const doc = document.createElement('div'); doc.innerHTML = currentMediaURL;
        const img = doc.querySelector('img');
        if (img && img.src.includes('/storage/v1/object/public/')) {
          // path looks like: https://<project>.supabase.co/storage/v1/object/public/<bucket>/<path>
          const parts = img.src.split('/');
          const bucketIndex = parts.indexOf('public') + 1;
          currentMediaPath = parts.slice(bucketIndex+1).join('/'); // best-effort
        } else {
          currentMediaPath = ""; // unknown
        }
      } catch(e){ currentMediaPath = ""; }

      const form = document.getElementById("entryForm");
      form.classList.remove("hidden");
      document.getElementById("mood").value = data.mood || "";
      document.getElementById("title").value = data.title || "";
      document.getElementById("content").value = data.content || "";
      const preview = document.getElementById("mediaPreview");
      preview.innerHTML = data.media || "";
      if (data.media) preview.classList.remove("hidden");
    }

    async function deleteEntry(id) {
      if (!confirm("Yakin mau hapus entry ini?")) return;
      // optional: fetch entry media path and try delete from storage
      const { data } = await db.from("entries").select("media").eq("id", id).single();
      if (data?.media) {
        try {
          const doc = document.createElement('div'); doc.innerHTML = data.media;
          const img = doc.querySelector('img');
          if (img && img.src.includes('/storage/v1/object/public/')) {
            const url = img.src;
            const idx = url.indexOf('/storage/v1/object/public/');
            const sub = url.substring(idx + '/storage/v1/object/public/'.length);
            const slashPos = sub.indexOf('/');
            const path = sub.substring(slashPos+1);
            await db.storage.from(PHOTO_BUCKET).remove([path]);
          }
        } catch(_) {}
      }
      await db.from("entries").delete().eq("id", id);
    }

    async function loveEntry(id) {
      const { data } = await db.from("entries").select("loves").eq("id", id).single();
      const loves = (data?.loves || 0) + 1;
      await db.from("entries").update({ loves }).eq("id", id);
    }

    async function addComment(e, id) {
      e.preventDefault();
      const input = e.target.querySelector("input");
      const { data } = await db.from("entries").select("comments").eq("id", id).single();
      const comments = data?.comments || [];
      const now = new Date();
      const time = now.toLocaleTimeString("id-ID", { hour:"2-digit", minute:"2-digit" });
      comments.push({ text: input.value, author: currentUser, time });
      await db.from("entries").update({ comments }).eq("id", id);
      input.value = "";
    }

    async function deleteComment(id, index) {
      const { data } = await db.from("entries").select("comments").eq("id", id).single();
      const comments = data.comments || [];
      comments.splice(index, 1);
      await db.from("entries").update({ comments }).eq("id", id);
    }

    // ---------- AUTH / UI ----------
    function login() {
      const { user, partner } = getTokens();
      const t1 = document.getElementById("token1").value;
      const t2 = document.getElementById("token2").value;
      if (t1 === user && t2 === partner) currentUser = "you";
      else if (t1 === partner && t2 === user) currentUser = "partner";
      else { document.getElementById("loginError").style.display = "block"; return; }

      localStorage.setItem("currentUser", currentUser);
      document.getElementById("loginPage").classList.add("hidden");
      document.getElementById("diaryPage").classList.remove("hidden");
      renderProfile();
      renderEntries();
      subscribeRealtime();
    }

    function logout() { localStorage.removeItem("currentUser"); location.reload(); }

    function toggleForm() {
      document.getElementById("entryForm").classList.toggle("hidden");
      editingIndex = null;
      currentMediaURL = "";
      currentMediaPath = "";
      document.getElementById("entryForm").reset();
      document.getElementById("mediaPreview").innerHTML = "";
    }

    function cancelEdit() {
      document.getElementById("entryForm").classList.add("hidden");
      editingIndex = null;
      currentMediaURL = "";
      currentMediaPath = "";
      document.getElementById("entryForm").reset();
      document.getElementById("mediaPreview").innerHTML = "";
      document.getElementById("mediaPreview").classList.add("hidden");
    }

    // ---------- REALTIME ----------
    function subscribeRealtime() {
      // unsubscribe previous channel(s) if any
      try { db.removeAllChannels(); } catch(e){}

      db.channel('realtime:entries')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'entries' }, async (payload) => {
          // refresh UI
          renderEntries();

          // personalized notif logic
          if (payload.eventType === "INSERT") {
            // new entry
            // show who: try payload.new.author
            const who = payload.new?.author === currentUser ? "Kamu" : "Pasanganmu";
            showNotif(`‚ú® ${who} menambah entry baru!`);
          } else if (payload.eventType === "UPDATE") {
            // check comments: fetch latest comments for that id
            try {
              const id = payload.new?.id || payload.old?.id;
              if (!id) { showNotif("üíå Ada update di diary!"); return; }
              const { data } = await db.from("entries").select("comments, author").eq("id", id).single();
              if (data && data.comments && data.comments.length > 0) {
                const last = data.comments[data.comments.length - 1];
                if (last.author && last.author !== currentUser) {
                  showNotif("üíï Pasanganmu kasih komentar baru!");
                } else {
                  showNotif("üíå Ada update di diary!");
                }
              } else {
                showNotif("üíå Ada update di diary!");
              }
            } catch (err) {
              showNotif("üíå Ada update di diary!");
            }
          } else if (payload.eventType === "DELETE") {
            showNotif("üóëÔ∏è Sebuah entry dihapus!");
          }
        })
        .subscribe();
    }

    // ---------- AUTO LOGIN ----------
    window.onload = () => {
      const saved = localStorage.getItem("currentUser");
      if (saved) {
        currentUser = saved;
        document.getElementById("loginPage").classList.add("hidden");
        document.getElementById("diaryPage").classList.remove("hidden");
        renderProfile();
        renderEntries();
        subscribeRealtime();
      }
    };
  </script>
</body>
</html>
